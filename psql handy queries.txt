-- Memory Map Database Schema
-- PostgreSQL migration for spaced repetition learning platform

-- Users table
CREATE TABLE users (
    id UUID PRIMARY KEY,
    first_name TEXT NOT NULL,
    last_name TEXT,
    email TEXT UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_users_email ON users(email);

-- Decks table
CREATE TABLE decks (
    id UUID PRIMARY KEY,
    owner_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    description TEXT,
    is_public BOOLEAN DEFAULT false,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_decks_owner_id ON decks(owner_id);

-- Cards table (flashcards with SM-2 algorithm state)
CREATE TABLE cards (
    id UUID PRIMARY KEY,
    deck_id UUID NOT NULL REFERENCES decks(id) ON DELETE CASCADE,
    front TEXT NOT NULL,
    back TEXT NOT NULL,
    
    -- SM-2 Algorithm State
    interval INTEGER DEFAULT 0,           -- Days until next review
    ease_factor DOUBLE PRECISION DEFAULT 2.5,  -- Card difficulty multiplier (min 1.3)
    repetitions INTEGER DEFAULT 0,        -- Consecutive successful recalls
    due_date TIMESTAMPTZ DEFAULT NOW(),   -- When to show this card next
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_cards_deck_id ON cards(deck_id);
CREATE INDEX idx_cards_due_date ON cards(due_date);

-- Review logs table (study session tracking)
CREATE TABLE review_logs (
    id UUID PRIMARY KEY,
    card_id UUID NOT NULL REFERENCES cards(id) ON DELETE CASCADE,
    
    -- User's performance
    rating INTEGER NOT NULL,              -- 1 (Again), 2 (Hard), 3 (Good), 4 (Easy)
    review_time TIMESTAMPTZ NOT NULL,    -- When the review occurred
    duration_ms INTEGER NOT NULL,         -- Time taken to answer (milliseconds)
    
    -- SM-2 algorithm result after this review
    new_interval INTEGER NOT NULL,        -- New interval scheduled
    new_ease DOUBLE PRECISION NOT NULL   -- New ease factor
);

CREATE INDEX idx_review_logs_card_id ON review_logs(card_id);
CREATE INDEX idx_review_logs_review_time ON review_logs(review_time);


3. Analytics Power-Moves (SQL Queries)
Because of the way we structured this table, you can now run some very powerful "Goldman-level" analytics queries with ease:

Total Time Studied: SELECT SUM(duration_ms) / 1000 / 60 as minutes_studied FROM review_logs;

Daily Review Count (Heatmap data): SELECT DATE_TRUNC('day', review_time) as day, COUNT(*) FROM review_logs GROUP BY day;

Retention Rate: SELECT rating, COUNT(*) * 100.0 / SUM(COUNT(*)) OVER() as percentage FROM review_logs GROUP BY rating;
